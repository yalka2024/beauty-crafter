// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User roles and authentication
enum UserRole {
  CLIENT
  PROVIDER
  ADMIN
}

enum UserStatus {
  ACTIVE
  PENDING
  SUSPENDED
  BANNED
}

enum ProviderType {
  BARBER
  NAIL_TECHNICIAN
  MASSAGE_THERAPIST
  COSMETIC_DERMATOLOGIST
  ESTHETICIAN
  HAIR_STYLIST
}

enum ServiceLocation {
  HOME
  SALON
  BOTH
}

enum BookingStatus {
  PENDING
  CONFIRMED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  NO_SHOW
}

enum PaymentStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  REFUNDED
}

enum LicenseStatus {
  ACTIVE
  EXPIRING_SOON
  EXPIRED
  PENDING_VERIFICATION
  SUSPENDED
}

enum ComplianceType {
  LICENSE_VERIFICATION
  BACKGROUND_CHECK
  INSURANCE_VERIFICATION
  CONTINUING_EDUCATION
  SAFETY_CERTIFICATION
}

// Main user table
model User {
  id            String      @id @default(cuid())
  email         String      @unique
  emailVerified DateTime?
  password      String?
  name          String
  phone         String?
  avatar        String?
  role          UserRole    @default(CLIENT)
  status        UserStatus  @default(ACTIVE)
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  // Profile information
  dateOfBirth   DateTime?
  gender        String?
  address       Address?
  
  // MFA (Multi-Factor Authentication)
  mfaSecret     String?
  mfaEnabled    Boolean @default(false)
  mfaBackupCodes String[]
  
  // Relationships
  client        Client?
  provider      Provider?
  admin         Admin?
  
  // Authentication
  accounts      Account[]
  sessions      Session[]
  refreshTokens RefreshToken[]
  
  // Notifications
  notifications Notification[]
  
  // Reviews
  sentReviews       Review[] @relation("ReviewSender")
  receivedReviews   Review[] @relation("ReviewReceiver")
  
  // Messages
  sentMessages     Message[] @relation("MessageSender")
  receivedMessages Message[] @relation("MessageReceiver")
  
  // Favorites
  clientFavorites    Favorite[] @relation("FavoriteClient")
  providerFavorites  Favorite[] @relation("FavoriteProvider")
  
  // Safety Acceptances
  safetyAcceptances UserSafetyAcceptance[]
  
  @@map("users")
}

// OAuth accounts
model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

// User sessions
model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

// Verification tokens
model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

// Refresh tokens for JWT rotation
model RefreshToken {
  id          String   @id @default(cuid())
  token       String   @unique
  userId      String
  jti         String   @unique // JWT ID for token identification
  expiresAt   DateTime
  isRevoked   Boolean  @default(false)
  revokedAt   DateTime?
  userAgent   String?
  ipAddress   String?
  createdAt   DateTime @default(now())
  lastUsedAt  DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("refresh_tokens")
}

// Address model
model Address {
  id          String @id @default(cuid())
  userId      String @unique
  street      String
  city        String
  state       String
  zipCode     String
  country     String @default("US")
  latitude    Float?
  longitude   Float?
  isDefault   Boolean @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("addresses")
}

// Client-specific information
model Client {
  id                    String @id @default(cuid())
  userId                String @unique
  preferences           Json?
  emergencyContact      String?
  medicalConditions     String[]
  allergies             String[]
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Relationships
  bookings    Booking[]
  favorites   Favorite[]
  reviews     Review[]
  payments    Payment[]

  @@map("clients")
}

// Provider-specific information
model Provider {
  id                    String @id @default(cuid())
  userId                String @unique
  providerType          ProviderType[]
  businessName          String?
  businessLicense       String?
  yearsOfExperience    Int?
  specialties           String[]
  bio                   String?
  hourlyRate            Decimal @db.Decimal(10, 2)
  travelRadius          Int? // in miles
  acceptsHomeService    Boolean @default(true)
  acceptsSalonService   Boolean @default(true)
  isAvailable           Boolean @default(true)
  rating                Decimal @db.Decimal(3, 2) @default(0)
  totalReviews          Int @default(0)
  completedServices     Int @default(0)
  joinDate              DateTime @default(now())
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Relationships
  services       Service[]
  bookings       Booking[]
  availability   Availability[]
  licenses       License[]
  insurance      Insurance[]
  backgroundChecks BackgroundCheck[]
  reviews        Review[]
  payments       Payment[]
  portfolio      Portfolio[]
  certifications Certification[]
  favorites      Favorite[]

  @@map("providers")
}

// Admin information
model Admin {
  id          String @id @default(cuid())
  userId      String @unique
  permissions String[]
  department  String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("admins")
}

// Services offered by providers
model Service {
  id              String @id @default(cuid())
  providerId      String
  name            String
  description     String
  category        String
  subcategory     String?
  duration        Int // in minutes
  price           Decimal @db.Decimal(10, 2)
  location        ServiceLocation @default(BOTH)
  isActive        Boolean @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  provider Provider @relation(fields: [providerId], references: [id], onDelete: Cascade)
  
  // Relationships
  bookings    Booking[]
  addOns      ServiceAddOn[]

  @@map("services")
}

// Service add-ons
model ServiceAddOn {
  id          String @id @default(cuid())
  serviceId   String
  name        String
  description String?
  price       Decimal @db.Decimal(10, 2)
  duration    Int // additional minutes
  isActive    Boolean @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  service Service @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  
  // Relations
  bookingAddOns BookingAddOn[]

  @@map("service_add_ons")
}

// Provider availability
model Availability {
  id          String @id @default(cuid())
  providerId  String
  dayOfWeek   Int // 0-6 (Sunday-Saturday)
  startTime   String // HH:MM format
  endTime     String // HH:MM format
  isAvailable Boolean @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  provider Provider @relation(fields: [providerId], references: [id], onDelete: Cascade)

  @@unique([providerId, dayOfWeek, startTime])
  @@map("availability")
}

// Bookings
model Booking {
  id              String @id @default(cuid())
  clientId        String
  providerId      String
  serviceId       String
  scheduledDate   DateTime
  startTime       String
  endTime         String
  duration        Int // in minutes
  location        ServiceLocation
  address         String? // for home service
  notes           String?
  status          BookingStatus @default(PENDING)
  totalAmount     Decimal @db.Decimal(10, 2)
  commission      Decimal @db.Decimal(10, 2)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  client   Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  provider Provider @relation(fields: [providerId], references: [id], onDelete: Cascade)
  service  Service  @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  
  // Relationships
  payments    Payment[]
  reviews     Review[]
  addOns      BookingAddOn[]

  @@map("bookings")
}

// Booking add-ons
model BookingAddOn {
  id          String @id @default(cuid())
  bookingId   String
  addOnId     String
  price       Decimal @db.Decimal(10, 2)
  createdAt   DateTime @default(now())

  booking Booking @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  addOn   ServiceAddOn @relation(fields: [addOnId], references: [id], onDelete: Cascade)

  @@map("booking_add_ons")
}

// Payments
model Payment {
  id              String @id @default(cuid())
  bookingId       String
  clientId        String
  providerId      String
  amount          Decimal @db.Decimal(10, 2)
  currency        String @default("USD")
  status          PaymentStatus @default(PENDING)
  stripePaymentId String?
  stripeRefundId  String?
  commission      Decimal @db.Decimal(10, 2)
  providerAmount  Decimal @db.Decimal(10, 2)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  booking  Booking  @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  client   Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  provider Provider @relation(fields: [providerId], references: [id], onDelete: Cascade)

  @@map("payments")
}

// Reviews and ratings
model Review {
  id          String @id @default(cuid())
  bookingId   String
  clientId    String
  providerId  String
  rating      Int // 1-5
  comment     String?
  isPublic    Boolean @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  booking  Booking  @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  client   Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  provider Provider @relation(fields: [providerId], references: [id], onDelete: Cascade)
  
  // Relation fields for User model
  clientUser   User @relation("ReviewSender", fields: [clientId], references: [id], onDelete: Cascade, map: "reviews_client_user_fkey")
  providerUser User @relation("ReviewReceiver", fields: [providerId], references: [id], onDelete: Cascade, map: "reviews_provider_user_fkey")

  @@unique([bookingId])
  @@map("reviews")
}

// License verification
model License {
  id              String @id @default(cuid())
  providerId      String
  licenseNumber   String
  state           String
  type            String
  issueDate       DateTime
  expiryDate      DateTime
  status          LicenseStatus @default(PENDING_VERIFICATION)
  verificationDate DateTime?
  verifiedBy      String?
  documentUrl     String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  provider Provider @relation(fields: [providerId], references: [id], onDelete: Cascade)

  @@map("licenses")
}

// Insurance verification
model Insurance {
  id              String @id @default(cuid())
  providerId      String
  policyNumber    String
  insuranceProvider String
  coverageAmount  Decimal @db.Decimal(12, 2)
  startDate       DateTime
  endDate         DateTime
  isActive        Boolean @default(true)
  documentUrl     String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  provider Provider @relation(fields: [providerId], references: [id], onDelete: Cascade)

  @@map("insurance")
}

// Background checks
model BackgroundCheck {
  id              String @id @default(cuid())
  providerId      String
  checkType       String
  status          String
  completedDate   DateTime?
  expiresDate     DateTime?
  documentUrl     String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  provider Provider @relation(fields: [providerId], references: [id], onDelete: Cascade)

  @@map("background_checks")
}

// Certifications
model Certification {
  id              String @id @default(cuid())
  providerId      String
  name            String
  issuingBody     String
  issueDate       DateTime
  expiryDate      DateTime?
  documentUrl     String?
  isActive        Boolean @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  provider Provider @relation(fields: [providerId], references: [id], onDelete: Cascade)

  @@map("certifications")
}

// User Safety Disclaimer Acceptance
model UserSafetyAcceptance {
  id              String @id @default(cuid())
  userId          String
  acceptedAt      DateTime
  providerId      String?
  serviceId       String?
  userAgent       String
  ipAddress       String
  metadata        Json?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_safety_acceptances")
}

// Portfolio items
model Portfolio {
  id          String @id @default(cuid())
  providerId  String
  title       String
  description String?
  imageUrl    String
  category    String
  isPublic    Boolean @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  provider Provider @relation(fields: [providerId], references: [id], onDelete: Cascade)

  @@map("portfolio")
}

// Favorites
model Favorite {
  id          String @id @default(cuid())
  clientId    String
  providerId  String
  createdAt   DateTime @default(now())

  client   Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  provider Provider @relation(fields: [providerId], references: [id], onDelete: Cascade)
  
  // Relation fields for User model
  clientUser   User @relation("FavoriteClient", fields: [clientId], references: [id], onDelete: Cascade, map: "favorites_client_user_fkey")
  providerUser User @relation("FavoriteProvider", fields: [providerId], references: [id], onDelete: Cascade, map: "favorites_provider_user_fkey")

  @@unique([clientId, providerId])
  @@map("favorites")
}

// Notifications
model Notification {
  id          String @id @default(cuid())
  userId      String
  title       String
  message     String
  type        String
  isRead      Boolean @default(false)
  data        Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("notifications")
}

// Messages between users
model Message {
  id          String @id @default(cuid())
  senderId    String
  receiverId  String
  content     String
  isRead      Boolean @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  sender   User @relation("MessageSender", fields: [senderId], references: [id], onDelete: Cascade)
  receiver User @relation("MessageReceiver", fields: [receiverId], references: [id], onDelete: Cascade)

  @@map("messages")
}

// Compliance alerts
model ComplianceAlert {
  id              String @id @default(cuid())
  providerId      String
  type            ComplianceType
  severity        String
  message         String
  isResolved      Boolean @default(false)
  resolvedBy      String?
  resolvedAt      DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@map("compliance_alerts")
}

// Analytics and metrics
model Analytics {
  id          String @id @default(cuid())
  date        DateTime
  metric      String
  value       Decimal @db.Decimal(15, 2)
  category    String?
  metadata    Json?
  createdAt   DateTime @default(now())

  @@map("analytics")
}

// API Key Management
model APIKey {
  id                String   @id @default(cuid())
  key               String   @unique
  hashedSecret      String
  name              String
  description       String?
  permissions       String[]
  rateLimitRequests Int      @default(1000)
  rateLimitWindow   Int      @default(3600) // in seconds
  allowedIPs        String[]
  allowedOrigins    String[]
  expiresAt         DateTime?
  isActive          Boolean  @default(true)
  lastUsedAt        DateTime?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Usage tracking
  usage APIKeyUsage[]

  @@map("api_keys")
}

model APIKeyUsage {
  id           String   @id @default(cuid())
  keyId        String
  endpoint     String
  method       String
  ipAddress    String
  userAgent    String
  timestamp    DateTime @default(now())
  responseTime Int      // in milliseconds
  statusCode   Int
  success      Boolean

  // Relationships
  apiKey APIKey @relation(fields: [keyId], references: [id], onDelete: Cascade)

  @@map("api_key_usage")
} 